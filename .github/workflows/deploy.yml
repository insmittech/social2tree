name: Deploy via FTP (Production)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 3. Install & Build React
        run: |
          npm install --legacy-peer-deps
          npm run build

      - name: 4. Prepare Deployment Package
        run: |
          mkdir deploy_package

          # A. Copy React Build (Frontend) to root
          cp -r dist/* deploy_package/

          # B. Create Backend API Folder Structure
          mkdir -p deploy_package/api
          cp -r public/api/* deploy_package/api/

          # C. Copy Database Schema (if needed for reference)
          if [ -d "server" ]; then 
            mkdir -p deploy_package/server
            cp -r server/* deploy_package/server/
          fi

          # D. Copy Environment Template
          if [ -f ".env" ]; then
            cp .env deploy_package/.env.example
          fi

          # E. Create .htaccess for URL Rewriting
          echo "<IfModule mod_rewrite.c>" > deploy_package/.htaccess
          echo "  RewriteEngine On" >> deploy_package/.htaccess
          echo "  RewriteBase /" >> deploy_package/.htaccess

          # 1. Force HTTPS (Prevents Loops)
          echo "" >> deploy_package/.htaccess
          echo "  # Force HTTPS" >> deploy_package/.htaccess
          echo "  RewriteCond %{HTTPS} off" >> deploy_package/.htaccess
          echo "  RewriteCond %{HTTP:X-Forwarded-Proto} !https" >> deploy_package/.htaccess
          echo "  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]" >> deploy_package/.htaccess

          # 2. Force non-www (optional - uncomment if needed)
          # echo "" >> deploy_package/.htaccess
          # echo "  # Force non-www" >> deploy_package/.htaccess
          # echo "  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]" >> deploy_package/.htaccess
          # echo "  RewriteRule ^(.*)$ https://%1/$1 [R=301,L]" >> deploy_package/.htaccess

          # 3. Protect API Folder (allow PHP execution)
          echo "" >> deploy_package/.htaccess
          echo "  # Allow API routes to work" >> deploy_package/.htaccess
          echo "  RewriteRule ^api/ - [L,NC]" >> deploy_package/.htaccess

          # 4. Ignore Real Files & Directories
          echo "" >> deploy_package/.htaccess
          echo "  # Don't rewrite files or directories that exist" >> deploy_package/.htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} -f [OR]" >> deploy_package/.htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} -d" >> deploy_package/.htaccess
          echo "  RewriteRule ^ - [L]" >> deploy_package/.htaccess

          # 5. Frontend Fallback (React Router)
          echo "" >> deploy_package/.htaccess
          echo "  # Fallback to index.html for React Router" >> deploy_package/.htaccess
          echo "  RewriteRule ^ index.html [L]" >> deploy_package/.htaccess
          echo "</IfModule>" >> deploy_package/.htaccess

          # F. Create API .htaccess (for cleaner URLs without .php extension)
          echo "<IfModule mod_rewrite.c>" > deploy_package/api/.htaccess
          echo "  RewriteEngine On" >> deploy_package/api/.htaccess
          echo "  RewriteBase /api/" >> deploy_package/api/.htaccess
          echo "" >> deploy_package/api/.htaccess
          echo "  # Remove .php extension" >> deploy_package/api/.htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} !-d" >> deploy_package/api/.htaccess
          echo "  RewriteCond %{REQUEST_FILENAME}\.php -f" >> deploy_package/api/.htaccess
          echo "  RewriteRule ^(.*)$ \$1.php [L]" >> deploy_package/api/.htaccess
          echo "</IfModule>" >> deploy_package/api/.htaccess

          echo "âœ“ Deployment package prepared"
          ls -la deploy_package/

      - name: 5. Deploy to Server (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy_package/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          security: loose
          timeout: 300000
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env.example
